From 9db9563a14b439556f19c91935e664cef5a45de6 Mon Sep 17 00:00:00 2001
From: Lu Hui <luhux76@gmail.com>
Date: Wed, 26 Jul 2023 21:26:36 +0800
Subject: [PATCH] examples/peripherals/usbdev/usbd_cdc_acm: usb acm echo

---
 .../peripherals/usbdev/usbd_cdc_acm/Makefile  |  1 +
 .../usbdev/usbd_cdc_acm/cdc_acm_template.c    | 44 ++-----------------
 .../peripherals/usbdev/usbd_cdc_acm/main.c    |  2 -
 3 files changed, 5 insertions(+), 42 deletions(-)

diff --git a/examples/peripherals/usbdev/usbd_cdc_acm/Makefile b/examples/peripherals/usbdev/usbd_cdc_acm/Makefile
index 44367c0..56df797 100644
--- a/examples/peripherals/usbdev/usbd_cdc_acm/Makefile
+++ b/examples/peripherals/usbdev/usbd_cdc_acm/Makefile
@@ -6,6 +6,7 @@ export BL_SDK_BASE
 CHIP ?= bl616
 BOARD ?= bl616dk
 CROSS_COMPILE ?= riscv64-unknown-elf-
+CONFIG_USB_HS ?= n
 
 # add custom cmake definition
 #cmake_definition+=-Dxxx=sss
diff --git a/examples/peripherals/usbdev/usbd_cdc_acm/cdc_acm_template.c b/examples/peripherals/usbdev/usbd_cdc_acm/cdc_acm_template.c
index 87b9d96..e01fcd0 100644
--- a/examples/peripherals/usbdev/usbd_cdc_acm/cdc_acm_template.c
+++ b/examples/peripherals/usbdev/usbd_cdc_acm/cdc_acm_template.c
@@ -93,10 +93,7 @@ static const uint8_t cdc_descriptor[] = {
     0x00
 };
 
-USB_NOCACHE_RAM_SECTION USB_MEM_ALIGNX uint8_t read_buffer[2048];
-USB_NOCACHE_RAM_SECTION USB_MEM_ALIGNX uint8_t write_buffer[2048];
-
-volatile bool ep_tx_busy_flag = false;
+USB_NOCACHE_RAM_SECTION USB_MEM_ALIGNX uint8_t read_buffer[1];
 
 #ifdef CONFIG_USB_HS
 #define CDC_MAX_MPS 512
@@ -107,7 +104,7 @@ volatile bool ep_tx_busy_flag = false;
 void usbd_configure_done_callback(void)
 {
     /* setup first out ep read transfer */
-    usbd_ep_start_read(CDC_OUT_EP, read_buffer, 2048);
+    usbd_ep_start_read(CDC_OUT_EP, read_buffer, 1);
 }
 
 void usbd_cdc_acm_bulk_out(uint8_t ep, uint32_t nbytes)
@@ -118,19 +115,12 @@ void usbd_cdc_acm_bulk_out(uint8_t ep, uint32_t nbytes)
     // }
     // printf("\r\n");
     /* setup next out ep read transfer */
-    usbd_ep_start_read(CDC_OUT_EP, read_buffer, 2048);
+    usbd_ep_start_read(CDC_OUT_EP, read_buffer, 1);
+    usbd_ep_start_write(CDC_IN_EP, read_buffer, 1);
 }
 
 void usbd_cdc_acm_bulk_in(uint8_t ep, uint32_t nbytes)
 {
-    USB_LOG_RAW("actual in len:%d\r\n", nbytes);
-
-    if ((nbytes % CDC_MAX_MPS) == 0 && nbytes) {
-        /* send zlp */
-        usbd_ep_start_write(CDC_IN_EP, NULL, 0);
-    } else {
-        ep_tx_busy_flag = false;
-    }
 }
 
 /*!< endpoint call back */
@@ -150,11 +140,6 @@ struct usbd_interface intf1;
 /* function ------------------------------------------------------------------*/
 void cdc_acm_init(void)
 {
-    const uint8_t data[10] = { 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30 };
-
-    memcpy(&write_buffer[0], data, 10);
-    memset(&write_buffer[10], 'a', 2038);
-
     usbd_desc_register(cdc_descriptor);
     usbd_add_interface(usbd_cdc_acm_init_intf(&intf0));
     usbd_add_interface(usbd_cdc_acm_init_intf(&intf1));
@@ -162,24 +147,3 @@ void cdc_acm_init(void)
     usbd_add_endpoint(&cdc_in_ep);
     usbd_initialize();
 }
-
-volatile uint8_t dtr_enable = 0;
-
-void usbd_cdc_acm_set_dtr(uint8_t intf, bool dtr)
-{
-    if (dtr) {
-        dtr_enable = 1;
-    } else {
-        dtr_enable = 0;
-    }
-}
-
-void cdc_acm_data_send_with_dtr_test(void)
-{
-    if (dtr_enable) {
-        ep_tx_busy_flag = true;
-        usbd_ep_start_write(CDC_IN_EP, write_buffer, 2048);
-        while (ep_tx_busy_flag) {
-        }
-    }
-}
\ No newline at end of file
diff --git a/examples/peripherals/usbdev/usbd_cdc_acm/main.c b/examples/peripherals/usbdev/usbd_cdc_acm/main.c
index fc0ca68..eb00eca 100644
--- a/examples/peripherals/usbdev/usbd_cdc_acm/main.c
+++ b/examples/peripherals/usbdev/usbd_cdc_acm/main.c
@@ -3,7 +3,6 @@
 #include "board.h"
 
 extern void cdc_acm_init(void);
-extern void cdc_acm_data_send_with_dtr_test(void);
 
 int main(void)
 {
@@ -11,7 +10,6 @@ int main(void)
 
     cdc_acm_init();
     while (1) {
-        cdc_acm_data_send_with_dtr_test();
         bflb_mtimer_delay_ms(500);
     }
 }
-- 
2.41.0

